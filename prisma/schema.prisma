generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("POSTGRES_PRISMA_URL")
  directUrl = env("POSTGRES_URL_NON_POOLING")
}

model TeamMember {
  id           String   @id @default(cuid())
  name         String
  email        String?  @unique
  role         String   // "cofounder", "engineer", "freelance"
  hourlyRate   Float?
  monthlyCost  Float?
  isActive     Boolean  @default(true)
  linearUserId String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  allocations     TimeAllocation[]
  demandForecasts DemandForecast[]
  meetings        ClientMeeting[]
}

model Customer {
  id              String   @id @default(cuid())
  displayName     String
  spreadsheetName String?
  bankName        String?
  emailDomain     String?  // e.g. "nouri.health" â€” for matching calendar attendees
  linearProjectId String?
  email           String?
  aliases         String[]
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  salesSnapshots  SalesSnapshot[]
  transactions    BankTransaction[]
  allocations     TimeAllocation[]
  demandForecasts DemandForecast[]
  margins         MonthlyMargin[]
  meetings        ClientMeeting[]
  domainMappings  DomainMapping[]
}

model DomainMapping {
  id          String    @id @default(cuid())
  domain      String    @unique
  meetingType String    // "client", "sales", "internal", "ignore"
  customerId  String?
  customer    Customer? @relation(fields: [customerId], references: [id])
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

model SalesSnapshot {
  id           String   @id @default(cuid())
  customerId   String
  customer     Customer @relation(fields: [customerId], references: [id])
  month        String   // "2026-01"
  snapshotDate DateTime
  amount       Float
  currency     String   @default("USD")
  notes        String?
  createdAt    DateTime @default(now())

  @@index([customerId, month])
  @@index([snapshotDate])
}

model BankTransaction {
  id               String    @id @default(cuid())
  mercuryId        String    @unique
  customerId       String?
  customer         Customer? @relation(fields: [customerId], references: [id])
  amount           Float
  currency         String    @default("USD")
  description      String
  counterpartyName String?
  status           String
  postedAt         DateTime?
  createdAt        DateTime  @default(now())
  isReconciled     Boolean   @default(false)
  reconciledMonth  String?
  direction        String    @default("incoming") // "incoming" or "outgoing"
  costCategory     String?   // "labor", "software", "other"

  @@index([customerId])
  @@index([postedAt])
  @@index([direction])
  @@index([costCategory])
}

model DemandForecast {
  id           String      @id @default(cuid())
  customerId   String
  customer     Customer    @relation(fields: [customerId], references: [id])
  teamMemberId String?
  teamMember   TeamMember? @relation(fields: [teamMemberId], references: [id])
  month        String
  forecastType String      // "this_week" or "next_week"
  hoursNeeded  Float
  confidence   String?     // "high", "medium", "low"
  notes        String?
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  @@index([customerId, month])
  @@index([teamMemberId, month])
}

model TimeAllocation {
  id           String     @id @default(cuid())
  teamMemberId String
  teamMember   TeamMember @relation(fields: [teamMemberId], references: [id])
  customerId   String
  customer     Customer   @relation(fields: [customerId], references: [id])
  month        String
  week         Int        // 1-5, week number within the month
  percentage   Float
  source       String     @default("manual") // "linear" or "manual"
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  @@unique([teamMemberId, customerId, month, week])
  @@index([month])
}

model LinearSyncCache {
  id       String   @id @default(cuid())
  month    String   @unique
  syncedAt DateTime
  data     String   // JSON-serialized completed issues
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model MonthlyMargin {
  id              String   @id @default(cuid())
  customerId      String
  customer        Customer @relation(fields: [customerId], references: [id])
  month           String
  revenue         Float
  engineeringCost Float
  margin          Float
  marginPercent   Float
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([customerId, month])
}

model VendorCategoryRule {
  id            String   @id @default(cuid())
  vendorPattern String   @unique // Substring match against counterpartyName
  category      String   // "labor", "software", "other"
  displayName   String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model MonthlyCostSummary {
  id           String   @id @default(cuid())
  month        String   @unique // "2026-01"
  laborCost    Float    @default(0)
  softwareCost Float    @default(0)
  otherCost    Float    @default(0)
  totalCost    Float    @default(0)
  calculatedAt DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model ClientMeeting {
  id              String      @id @default(cuid())
  googleEventId   String      @unique
  meetingType     String      @default("client") // "client", "sales", "internal"
  customerId      String?
  customer        Customer?   @relation(fields: [customerId], references: [id])
  teamMemberId    String
  teamMember      TeamMember  @relation(fields: [teamMemberId], references: [id])
  date            DateTime
  durationMinutes Int
  title           String
  attendeeEmails  String[]
  externalDomains String[]
  syncedAt        DateTime    @default(now())

  @@index([customerId, date])
  @@index([teamMemberId, date])
  @@index([meetingType])
}
